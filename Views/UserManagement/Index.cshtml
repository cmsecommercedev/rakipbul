@model List<RakipBul.Models.User>
@{
    ViewData["Title"] = "Kullanıcı Yönetimi";
    Layout = "_AdminLayout";
    var roller = new List<string> { "Admin", "Captain", "CityAdmin", "Player", "Announcer", "Public" };
}

<div class="min-h-screen bg-gray-900 text-gray-100">
    <div class="max-w-full mx-auto py-6 px-2 sm:px-4 md:px-6 lg:px-10">
        @if (TempData["Success"] != null)
        {
            <div class="mb-4 p-4 bg-green-600 text-white rounded-lg">
                @TempData["Success"]
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="mb-4 p-4 bg-red-600 text-white rounded-lg">
                @TempData["Error"]
            </div>
        }

        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
            <h2 class="text-xl font-semibold text-yellow-500">Kullanıcı Listesi</h2>
            <div class="flex flex-row gap-2 w-full sm:w-auto items-center">
                <select id="roleFilter" class="bg-gray-700 text-white rounded-md px-3 py-2 border border-gray-600 focus:outline-none focus:border-indigo-500" onchange="fetchUsersByRole()">
                    @foreach (var rol in roller)
                    {
                        <option value="@rol">@rol</option>
                    }
                </select>
                <input type="text" id="userSearchInput" placeholder="Kullanıcı Ara (Email, Ad, Soyad)..."
                       class="w-full sm:w-64 bg-gray-700 text-white rounded-md px-3 py-2 border border-gray-600 focus:outline-none focus:border-indigo-500 placeholder-gray-400"
                       onkeyup="searchUsers()">
                <span class="flex items-center pr-3">
                    <i class="fas fa-search text-gray-400"></i>
                </span>
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
            <div class="p-4 md:p-6">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Email</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Ad</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Soyad</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Rol</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">İşlemler</th>
                            </tr>
                        </thead>
                        <tbody class="bg-gray-800 divide-y divide-gray-700" id="userTableBody">
                            <tr id="noResultsRow" class="hidden">
                                <td colspan="5" class="text-center py-4 text-gray-500">Arama kriterlerine uygun kullanıcı bulunamadı.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="paginationControls" class="flex justify-center mt-4 space-x-2"></div>
    </div>
</div>

<!-- Modal HTML -->
<div id="pushModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md shadow-lg relative">
        <button type="button" class="absolute top-2 right-2 text-gray-400 hover:text-white" onclick="closePushModal()">
            <i class="fas fa-times"></i>
        </button>
        <h3 class="text-lg font-semibold text-yellow-400 mb-4">Push Bildirim Gönder</h3>
        <form id="pushForm" onsubmit="sendPush(event)">
            <input type="hidden" id="pushUserId" name="userId" />
            <div class="mb-3">
                <label class="block text-gray-300 mb-1">Kime:</label>
                <span id="pushUserName" class="text-gray-200"></span>
            </div>
            <div class="mb-3">
                <label for="pushTitle" class="block text-gray-300 mb-1">Başlık</label>
                <input id="pushTitle" name="title" type="text" class="w-full px-3 py-2 rounded bg-gray-700 text-white border border-gray-600" required />
            </div>
            <div class="mb-3">
                <label for="pushMessage" class="block text-gray-300 mb-1">Mesaj</label>
                <textarea id="pushMessage" name="message" class="w-full px-3 py-2 rounded bg-gray-700 text-white border border-gray-600" required></textarea>
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="closePushModal()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">İptal</button>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Gönder</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
               let currentPage = 1; // Başlangıç sayfası
        const pageSize = 50; // Her sayfada gösterilecek kullanıcı sayısı
        let totalUsers = 0; // Toplam kullanıcı sayısı

        async function fetchUsersByRole() {
            const role = document.getElementById('roleFilter').value;
            const search = document.getElementById('userSearchInput').value.toLowerCase();
            const url = `/UserManagement/GetUsersByRole?role=${encodeURIComponent(role)}&page=${currentPage}&pageSize=${pageSize}`;

            const response = await fetch(url);
            const data = await response.json();
            const users = data.users;
            totalUsers = data.totalUsers; // Toplam kullanıcı sayısını güncelle

            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';
            let found = false;

            users.forEach(user => {
                if (
                    user.email.toLowerCase().includes(search) ||
                    (user.firstname && user.firstname.toLowerCase().includes(search)) ||
                    (user.lastname && user.lastname.toLowerCase().includes(search))
                ) {
                    found = true;
                    tbody.innerHTML += `
        <tr class="user-row hover:bg-gray-700 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-100">${user.email}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-100">${user.firstname ?? ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-100">${user.lastname ?? ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-100">${user.userRole ?? ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                <a href="/UserManagement/Edit/${user.id}"
                   class="bg-blue-600 text-white px-3 py-1 rounded-md text-xs hover:bg-blue-700 whitespace-nowrap inline-flex items-center">
                    <i class='fas fa-edit mr-1'></i> Düzenle
                </a>
                <button type="button"
                        class="bg-green-600 text-white px-3 py-1 rounded-md text-xs hover:bg-green-700 whitespace-nowrap inline-flex items-center ml-2"
                        onclick="openPushModal('${user.id}', '${user.firstname ?? ''} ${user.lastname ?? ''}')">
                    <i class='fas fa-paper-plane mr-1'></i> Push Gönder
                </button>
            </td>
        </tr>`;
                }
            });

            if (!found) {
                tbody.innerHTML = `<tr id="noResultsRow"><td colspan="5" class="text-center py-4 text-gray-500">Arama kriterlerine uygun kullanıcı bulunamadı.</td></tr>`;
            }

            updatePaginationControls();
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(totalUsers / pageSize);
            const paginationContainer = document.getElementById('paginationControls');
            paginationContainer.innerHTML = '';

            if (currentPage > 1) {
                paginationContainer.innerHTML += `<button onclick="changePage(${currentPage - 1})" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Önceki</button>`;
            }

            if (currentPage < totalPages) {
                paginationContainer.innerHTML += `<button onclick="changePage(${currentPage + 1})" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Sonraki</button>`;
            }
        }

        function changePage(page) {
            currentPage = page;
            fetchUsersByRole();
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchUsersByRole();
        });
         
        async function searchUsers(page = 1) {
            const search = document.getElementById('userSearchInput').value.trim();
           if (search.length > 0 && search.length < 3) {            
            return;
        }
            if (!search) {
                fetchUsersByRole();
                return;
            }
            const url = `/UserManagement/SearchUsers?query=${encodeURIComponent(search)}&page=${page}&pageSize=${pageSize}`;
            const response = await fetch(url);
            const data = await response.json();
            const users = data.users;
            totalUsers = data.totalUsers;
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';
            let found = false;

            users.forEach(user => {
                found = true;
                tbody.innerHTML += `
        <tr class="user-row hover:bg-gray-700 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-100">${user.email}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-100">${user.firstname ?? ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-100">${user.lastname ?? ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-100">${user.userRole ?? ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                <a href="/UserManagement/Edit/${user.id}"
                   class="bg-blue-600 text-white px-3 py-1 rounded-md text-xs hover:bg-blue-700 whitespace-nowrap inline-flex items-center">
                    <i class='fas fa-edit mr-1'></i> Düzenle
                </a>
                <button type="button"
                        class="bg-green-600 text-white px-3 py-1 rounded-md text-xs hover:bg-green-700 whitespace-nowrap inline-flex items-center ml-2"
                        onclick="openPushModal('${user.id}', '${user.firstname ?? ''} ${user.lastname ?? ''}')">
                    <i class='fas fa-paper-plane mr-1'></i> Push Gönder
                </button>
            </td>
        </tr>`;
            });

            if (!found) {
                tbody.innerHTML = `<tr id="noResultsRow"><td colspan="5" class="text-center py-4 text-gray-500">Arama kriterlerine uygun kullanıcı bulunamadı.</td></tr>`;
            }

            updatePaginationControlsForSearch();
        }

        function updatePaginationControlsForSearch() {
            const totalPages = Math.ceil(totalUsers / pageSize);
            const paginationContainer = document.getElementById('paginationControls');
            paginationContainer.innerHTML = '';

            if (currentPage > 1) {
                paginationContainer.innerHTML += `<button onclick="changeSearchPage(${currentPage - 1})" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Önceki</button>`;
            }
            if (currentPage < totalPages) {
                paginationContainer.innerHTML += `<button onclick="changeSearchPage(${currentPage + 1})" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Sonraki</button>`;
            }
        }

        function changeSearchPage(page) {
            currentPage = page;
            searchUsers(page);
        }

        // Enter tuşu ile arama
        document.getElementById('userSearchInput').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                currentPage = 1;
                searchUsers();
            }
        });

        // Arama kutusu boşsa role göre listele
        document.getElementById('userSearchInput').addEventListener('input', function () {
            if (!this.value.trim()) {
                currentPage = 1;
                fetchUsersByRole();
            }
        });
    </script>
}