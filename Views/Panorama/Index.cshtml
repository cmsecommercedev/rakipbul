@model PanoramaViewModel
@{
    ViewBag.Title = "Haftanın Panoraması";
    Layout = "_AdminLayout";

    var leagues = Model.Leagues as IEnumerable<RakipbulLeagueDto> ?? new List<RakipbulLeagueDto>();
    var seasons = Model.Seasons as IEnumerable<RakipbulSeasonDto> ?? new List<RakipbulSeasonDto>();

    var activeTab = Model.ActiveTab == 2 ? 2 : 1;
}

<div class="max-w-6xl mx-auto p-6">
    <h2 class="text-2xl font-bold text-gray-200 mb-6">Haftanın Panoraması</h2>

    @if (TempData["Success"] != null)
    {
        <div class="mb-4 p-3 rounded-lg text-sm bg-green-600 text-white">@TempData["Success"]</div>
    }

    <!-- TAB HEADER -->
    <div class="mb-6 flex gap-2">
        <button type="button"
                class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold transition-all @(activeTab == 1 ? "bg-yellow-500 text-gray-900" : "bg-gray-800 text-gray-300 hover:bg-gray-700")"
                data-tab="panorama">
            Panorama
        </button>
        <button type="button"
                class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold transition-all @(activeTab == 2 ? "bg-yellow-500 text-gray-900" : "bg-gray-800 text-gray-300 hover:bg-gray-700")"
                data-tab="goals">
            Haftanın Golleri
        </button>
    </div>

    <!-- TAB PANORAMA -->
    <div id="tab-panorama" class="tab-panel @(activeTab == 1 ? "" : "hidden")">
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h3 class="text-lg font-semibold text-gray-100 mb-4">Yeni Panorama</h3>
            <form asp-action="Index" method="post" x-data="playerSearchComponent()" class="space-y-4">
                <input type="hidden" name="TeamName" x-model="selectedTeamName" />
                <input type="hidden" name="LeagueName" x-model="selectedLeagueName" />
                <input type="hidden" name="ProvinceName" x-model="selectedProvinceName" />
                <input type="hidden" name="PlayerId" x-model="selectedPlayerId" />
                <input type="hidden" name="PlayerName" x-model="selectedPlayerName" />
                <input type="hidden" name="PlayerJson" x-model="selectedPlayerJson" />
                <input type="hidden" name="ActiveTab" value="1" />

                <div>
                    <label class="block text-gray-300 mb-1">Lig Seçin</label>
                    <select id="LeagueId" name="LeagueId"
                            class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500">
                        <option value="">-- Lig Seçin --</option>
                        @foreach (var league in leagues)
                        {
                            if (Model.SelectedLeagueId == league.Id)
                            {
                                <option value="@league.Id" selected>@league.Name</option>
                            }
                            else
                            {
                                <option value="@league.Id">@league.Name</option>
                            }
                        }
                    </select>
                </div>

                <div>
                    <label class="block text-gray-300 mb-1">Sezon Seçin</label>
                    <select id="SeasonId" name="SeasonId"
                            class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500">
                        <option value="">-- Sezon Seçin --</option>
                        @foreach (var season in seasons)
                        {
                            <option value="@season.Id" selected="@(Model.SelectedSeason == season.Fullname)">
                                @season.Fullname (@season.Year)
                            </option>
                        }
                    </select>
                    <p class="text-xs text-gray-400 mt-1">Lig seçtiğinizde sezonlar otomatik güncellenecek.</p>
                </div>

                <div>
                    <label class="block text-gray-300 mb-1">Başlık</label>
                    <input type="text" name="Title" value="@Model.Title"
                           placeholder="Haftanın panoraması başlığı..."
                           class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500" />
                </div>

                <div class="relative">
                    <label class="block text-gray-300 mb-1">Oyuncu Ara</label>
                    <input type="text"
                           x-model="query"
                           @@input="onInput"
                           placeholder="Oyuncu ara (3 harf ve üzeri)..."
                           class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500" />

                    <div x-show="loading" class="flex justify-center py-4">
                        <div class="w-6 h-6 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin"></div>
                    </div>

                    <div x-show="open && results.length > 0"
                         @@click.away="open = false"
                         class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3">

                        <template x-for="p in results" :key="p.id">
                            <div @@click="selectPlayer(p)"
                                 class="bg-gray-800 border border-gray-700 rounded-lg p-3 cursor-pointer hover:bg-gray-700 transition flex flex-col items-center text-center relative">
                                <img :src="p.image_Url || '/images/default-player.png'"
                                     class="w-16 h-16 rounded-full border-2 border-gray-600 mb-2 object-cover" />

                                <div class="absolute top-1 right-1 bg-gray-900 text-white text-xs px-1.5 py-0.5 rounded">
                                    #<span x-text="p.number || '-'"></span>
                                </div>

                                <div class="font-semibold text-gray-200 text-xs mb-1" x-text="p.fullname"></div>
                                <div class="text-xs text-gray-400 mb-1" x-text="p.position?.name ?? 'Pozisyon'"></div>

                                <div class="flex items-center gap-1.5 mb-1">
                                    <img :src="p.team?.image_Url || '/images/default_team.png'"
                                         class="w-5 h-5 rounded-full border border-gray-600" />
                                    <span class="text-xs text-gray-300" x-text="p.team?.name ?? 'Takım Yok'"></span>
                                </div>

                                <span class="text-[10px] px-2 py-0.5 rounded-full text-white"
                                      :class="leagueColor(p.team?.league?.name)"
                                      x-text="p.team?.league?.name">
                                </span>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-300 mb-1">Başlangıç Tarihi</label>
                        <input type="date" id="StartDate" name="StartDate"
                               value="@Model.StartDate?.ToString("yyyy-MM-dd")"
                               class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500" />
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-1">Bitiş Tarihi</label>
                        <input type="date" id="EndDate" name="EndDate"
                               value="@Model.EndDate?.ToString("yyyy-MM-dd")"
                               class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500" />
                    </div>
                </div>

                <div>
                    <label class="block text-gray-300 mb-1">YouTube Embed Linki</label>
                    <input type="text" id="YoutubeEmbedLink" name="YoutubeEmbedLink"
                           value="@Model.YoutubeEmbedLink"
                           placeholder="https://www.youtube.com/embed/..."
                           class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500" />
                    <p class="text-xs text-gray-400 mt-1">Direkt <code class="bg-gray-900 px-1 py-0.5 rounded text-gray-300">/embed/</code> formatında link vermeniz önerilir.</p>
                </div>

                <div class="flex justify-end">
                    <button type="submit" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-semibold rounded-lg">
                        Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- TAB HAFTANIN GOLLERI -->
    <div id="tab-goals" class="tab-panel @(activeTab == 2 ? "" : "hidden")">
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h3 class="text-lg font-semibold text-gray-100 mb-4">Haftanın Golleri</h3>
            <form asp-action="Index" method="post" x-data="playerSearchComponent()" class="space-y-4">
                <input type="hidden" name="TeamName" x-model="selectedTeamName" />
                <input type="hidden" name="LeagueName" x-model="selectedLeagueName" />
                <input type="hidden" name="ProvinceName" x-model="selectedProvinceName" />
                <input type="hidden" name="PlayerId" x-model="selectedPlayerId" />
                <input type="hidden" name="PlayerName" x-model="selectedPlayerName" />
                <input type="hidden" name="PlayerJson" x-model="selectedPlayerJson" />
                <input type="hidden" name="ActiveTab" value="2" />

                <div>
                    <label class="block text-gray-300 mb-1">Lig Seçin</label>
                    <select id="LeagueIdGoals" name="LeagueId"
                            class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500">
                        <option value="">-- Lig Seçin --</option>
                        @foreach (var league in leagues)
                        {
                            if (Model.SelectedLeagueId == league.Id)
                            {
                                <option value="@league.Id" selected>@league.Name</option>
                            }
                            else
                            {
                                <option value="@league.Id">@league.Name</option>
                            }
                        }
                    </select>
                </div>

                <div>
                    <label class="block text-gray-300 mb-1">Sezon Seçin</label>
                    <select id="SeasonIdGoals" name="SeasonId"
                            class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500">
                        <option value="">-- Sezon Seçin --</option>
                        @foreach (var season in seasons)
                        {
                            <option value="@season.Id" selected="@(Model.SelectedSeason == season.Fullname)">
                                @season.Fullname (@season.Year)
                            </option>
                        }
                    </select>
                    <p class="text-xs text-gray-400 mt-1">Lig seçtiğinizde sezonlar otomatik güncellenecek.</p>
                </div>

                <div>
                    <label class="block text-gray-300 mb-1">Başlık</label>
                    <input type="text" name="Title" value="@Model.Title"
                           placeholder="Haftanın golleri başlığı..."
                           class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500" />
                </div>

                <div class="relative">
                    <label class="block text-gray-300 mb-1">Oyuncu Ara</label>
                    <input type="text"
                           x-model="query"
                           @@input="onInput"
                           placeholder="Oyuncu ara (3 harf ve üzeri)..."
                           class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500" />

                    <div x-show="loading" class="flex justify-center py-4">
                        <div class="w-6 h-6 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin"></div>
                    </div>

                    <div x-show="open && results.length > 0"
                         @@click.away="open = false"
                         class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3">

                        <template x-for="p in results" :key="p.id">
                            <div @@click="selectPlayer(p)"
                                 class="bg-gray-800 border border-gray-700 rounded-lg p-3 cursor-pointer hover:bg-gray-700 transition flex flex-col items-center text-center relative">
                                <img :src="p.image_Url || '/images/default-player.png'"
                                     class="w-16 h-16 rounded-full border-2 border-gray-600 mb-2 object-cover" />

                                <div class="absolute top-1 right-1 bg-gray-900 text-white text-xs px-1.5 py-0.5 rounded">
                                    #<span x-text="p.number || '-'"></span>
                                </div>

                                <div class="font-semibold text-gray-200 text-xs mb-1" x-text="p.fullname"></div>
                                <div class="text-xs text-gray-400 mb-1" x-text="p.position?.name ?? 'Pozisyon'"></div>

                                <div class="flex items-center gap-1.5 mb-1">
                                    <img :src="p.team?.image_Url || '/images/default_team.png'"
                                         class="w-5 h-5 rounded-full border border-gray-600" />
                                    <span class="text-xs text-gray-300" x-text="p.team?.name ?? 'Takım Yok'"></span>
                                </div>

                                <span class="text-[10px] px-2 py-0.5 rounded-full text-white"
                                      :class="leagueColor(p.team?.league?.name)"
                                      x-text="p.team?.league?.name">
                                </span>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-300 mb-1">Hafta Başlangıç Tarihi</label>
                        <input type="date" name="StartDate"
                               value="@Model.StartDate?.ToString("yyyy-MM-dd")"
                               class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500" />
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-1">Hafta Bitiş Tarihi</label>
                        <input type="date" name="EndDate"
                               value="@Model.EndDate?.ToString("yyyy-MM-dd")"
                               class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500" />
                    </div>
                </div>

                <div>
                    <label class="block text-gray-300 mb-1">Haftanın Golleri - YouTube Embed Linki</label>
                    <input type="text" name="YoutubeEmbedLink"
                           value="@Model.YoutubeEmbedLink"
                           placeholder="https://www.youtube.com/embed/..."
                           class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500" />
                </div>

                <div class="flex justify-end">
                    <button type="submit" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-semibold rounded-lg">
                        Haftanın Golünü Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="panorama-list-container">
    @await Html.PartialAsync("_PanoramaList", Model.PanoramaList)
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<script>
    document.querySelectorAll(".tab-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
            var target = this.getAttribute("data-tab");

            document.querySelectorAll(".tab-btn").forEach(function (b) {
                b.classList.remove("bg-yellow-500", "text-gray-900");
                b.classList.add("bg-gray-800", "text-gray-300");
            });

            this.classList.remove("bg-gray-800", "text-gray-300");
            this.classList.add("bg-yellow-500", "text-gray-900");

            document.querySelectorAll(".tab-panel").forEach(function (panel) {
                panel.classList.add("hidden");
            });

            var activePanel = document.getElementById("tab-" + target);
            if (activePanel) {
                activePanel.classList.remove("hidden");
            }
        });
    });

    $(document).on("change", "#LeagueId, #LeagueIdGoals", function () {
        let leagueId = $(this).val();
        let seasonSelect = $(this).closest("form").find("select[name='SeasonId']");
        
        seasonSelect.empty().append(`<option value="">-- Sezon Seçin --</option>`);
        if (leagueId === "") return;

        $.ajax({
            url: `/Panorama/GetSeasons?leagueId=${leagueId}`,
            type: "GET",
            success: function (data) {
                data.forEach(function (s) {
                    seasonSelect.append(
                        `<option value="${s.id}">${s.fullname} (${s.year})</option>`
                    );
                });
            }
        });
    });

    function playerSearchComponent() {
        return {
            query: "",
            results: [],
            loading: false,
            open: false,
            selectedPlayerId: "",
            selectedPlayerJson: "",
            selectedPlayerName: "",
            debounceTimer: null,

            leagueColor(name) {
                if (!name) return "bg-gray-700";
                name = name.toLowerCase();
                if (name.includes("istanbul")) return "bg-blue-600";
                if (name.includes("ankara")) return "bg-red-600";
                if (name.includes("izmir")) return "bg-purple-600";
                if (name.includes("bursa")) return "bg-green-600";
                if (name.includes("adana")) return "bg-orange-500";
                if (name.includes("antalya")) return "bg-amber-500";
                if (name.includes("gaziantep")) return "bg-rose-600";
                return "bg-gray-700";
            },

            onInput() {
                if (this.query.length < 3) {
                    this.open = false;
                    return;
                }
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    this.searchPlayers();
                }, 250);
            },

            searchPlayers() {
                this.loading = true;
                this.open = false;
                this.results = [];
                setTimeout(() => {
                    fetch(`/Panorama/SearchPlayers?term=${encodeURIComponent(this.query)}`)
                        .then(res => res.json())
                        .then(data => {
                            this.results = data;
                            this.open = true;
                        })
                        .finally(() => {
                            this.loading = false;
                        });
                }, 10);
            },

            selectPlayer(p) {
                this.query = p.fullname;
                this.selectedPlayerId = p.id;
                this.selectedPlayerName = p.fullname;
                this.selectedPlayerJson = JSON.stringify(p);
                this.open = false;
            }
        }
    }
</script>

<script>
    $(document).on("submit", "#panorama-filter-form", function (e) {
        e.preventDefault();
        $("#loading").removeClass("hidden");
        $.ajax({
            url: "/Panorama/Filter",
            type: "GET",
            data: $(this).serialize(),
            success: function (html) {
                $("#panorama-list-container").html(html);
            },
            complete: function () {
                $("#loading").addClass("hidden");
            }
        });
    });
</script>

<script>
    function videoModal() {
        return {
            isOpen: false,
            embedUrl: '',
            init() {
                window.addEventListener('trigger-video-modal', (e) => {
                    this.openVideo(e.detail.url);
                });
            },
            openVideo(url) {
                this.embedUrl = url + (url.includes('?') ? '&' : '?') + "autoplay=1";
                this.isOpen = true;
            },
            close() {
                this.embedUrl = "";
                this.isOpen = false;
            }
        }
    }
</script>

<div x-data="videoModal()" x-init="init()" x-cloak>
    <div x-show="isOpen"
         class="fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] backdrop-blur-sm"
         x-transition.opacity>
        <div class="bg-gray-900 w-full max-w-4xl rounded-lg shadow-2xl relative p-1 border border-gray-700"
             @@click.away="close()">
            <button class="absolute -top-10 right-0 text-white hover:text-gray-300 transition font-semibold text-lg"
                    @@click="close()">
                ✕ Kapat
            </button>
            <div class="relative w-full bg-black rounded-lg overflow-hidden" style="padding-top: 56.25%;">
                <iframe x-bind:src="embedUrl"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen
                        class="absolute inset-0 w-full h-full">
                </iframe>
            </div>
        </div>
    </div>
</div>
